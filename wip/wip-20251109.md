# WIP - 2025/11/09 進度報告

## 今日完成項目

### 1. docker-compose-local 修復
- **處理內容**：重新檢查 `backend/docker-compose-local-*.yml` 所需的 `.env` 與 `backend/conf/*/.env` 檔案，補齊缺失變數並校正拼寫，確保 `docker compose -f docker-compose-local-dev.yml up` 及 `docker-compose-local-prod.yml` 均能一次啟動。
- **驗證**：本地開啟 web、celery、celery-beat、nginx 後，所有 health check 與 admin static 路徑皆可存取。
- **成果**：CI/CD 依賴的 compose 檔已與本地同步，後續 smoke test 不再因環境檔缺失而失敗。

### 2. CI/CD workflows 擴充與 retag 清理修復
- **新建/調整 workflows**：
  - `feature_unit_test.yml`：明確鎖定 `ci-*`, `feature-*`, `fix-*`, `refactor-*`, `test-*`, `chore-*`, `build-*` 等分支，一 push 即建置 docker-compose 測試堆疊並跑 unit/integration。
  - `dev_smoke_test.yml`：在 PR merge 到 `dev` 後，自動建 runtime images、寫 `.env`、啟動 smoke test，再推送 `${service}-${{ github.sha }}` 到 ECR。
  - `dev_promote_approved_tag.yml`：提供手動流程將「已驗證的 dev tag」寫入 `prod` environment 變數 `APPROVED_DEV_TAG`。
  - `prod_retag_deploy.yml`：從 `main` 觸發，拉取上一步批准的 dev tag，計算 release tag，retag/push，最後清除舊 dev tag。
- **retag 問題**：`prod_retag_deploy.yml` 使用整條 ECR registry URL 當 `--repository-name`，導致 `aws ecr batch-delete-image` 失敗，舊的 `${service}-${APPROVED_DEV_TAG}` 無法清除。
- **解法**：在 workflow 內以 `repo_name="${ECR_REPO##*/}"` 擷取 repo 名稱後再刪除，並重新推送以驗證 `Cleanup dev tags` 步驟成功。
- **補充**：同步更新 `fyi/CICD/fyi-CICD-guideline.md`，記錄 unit test → dev smoke → push images → approved tag → prod retag 的完整鏈路。

### 3. Git 分支同步與 rebase SOP
- **重點**：將落後 106 commits 的 `main` fast-forward，說明個人分支 rebase (`git pull origin main` → `git rebase main` → `git push --force-with-lease`) 的作法。
- **結論**：功能分支維持線性歷史，`dev`/`main` 這類共享分支則以 merge 同步，避免重寫他人提交。

## 技術學習收穫

### Docker Compose 與環境檔整合
1. Docker Compose 層級：`.env` 供 `${VAR}` 解析。
2. Container 層級：`$${VAR}` 仍由 container 內 env 解析。
3. Application 層級：`env_file` 讓 Django/Celery 接收設定。  
=> 只有確保三層來源一致，`docker-compose-local` 才能與 CI/CD 行為對齊。

### ECR CLI 使用細節
- `aws ecr batch-delete-image --repository-name` 只接受 repo 名稱，需先剝除 registry host；使用 Bash 字串運算 (`${var##*/}`) 可快速取得。

### Workflow 觸發控制
- 了解 `paths` / `paths-ignore` 搭配 commit message flag 的可行性，為日後減少 doc-only 變更觸發重型 workflow 做準備。

## 下次目標進度

### 主要任務：Doc-only 觸發條件與 Promotion 守門人
1. **實作 doc-only skip**  
   - 在 `feature_unit_test.yml`、`dev_smoke_test.yml` 加入 `paths-ignore`（涵蓋 `fyi/**`, `docs/**`, `*.md`）。  
   - 規劃 commit message 旗標，必要時可強制執行。
2. **加強 prod 環境守門**  
   - 對 `prod_retag_deploy` 引入 GitHub Environment 批准或通知流程。
3. **文件化 Git / CI SOP**  
   - 把 rebase 步驟、workflow 觸發、ECR tag 規則寫入 `CONVENTIONS.md` 或 `fyi/CICD/`，降低口頭溝通成本。

#### 預期成果
- 文檔變更不再推動 Docker build/ECR 推送。  
- 每次 prod retag 都有明確的批准與操作守則。  
- 新進成員能快速理解 Git Flow 與 CI/CD 流程。

## 備註
- 專案統一使用 Docker Compose v2（`docker compose`）；所有 script/workflow 已同步。  
- 修改 `.github/workflows/` 前建議先本地 lint（例如 `yamllint`）以避免 syntax error 阻斷 pipeline。  
- 目前 CI/CD 仍需手動在 EC2 驗證 dev tag，後續若導入 staging workflow 需重新評估資源配置。
